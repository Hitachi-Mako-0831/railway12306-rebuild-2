# ============================================
# REQ-4: 乘客管理系统
# 负责人: [待填写]
# 关联前端: frontend/src/views/user/PassengerPage.vue
# 关联后端: backend/app/api/v1/endpoints/passengers.py
# 数据库表: passengers (PostgreSQL)
# ============================================

id: REQ-4
name: 乘客管理系统
description: 允许用户管理常用的乘车人信息，包含增删改查及与用户账号的自动同步。

# ------------------------------------------
# 数据库设计规范 (PostgreSQL)
# ------------------------------------------
database_spec:
  table_name: passengers
  comment: "存储用户的常用乘车人信息"
  columns:
    - name: id
      type: SERIAL / BIGSERIAL
      constraint: PRIMARY KEY
      description: "主键ID"
    - name: user_id
      type: INTEGER / BIGINT
      constraint: NOT NULL, FOREIGN KEY -> users(id)
      description: "关联的登录用户ID"
    - name: name
      type: VARCHAR(50)
      constraint: NOT NULL
      description: "乘车人真实姓名"
    - name: id_type
      type: SMALLINT
      constraint: NOT NULL, DEFAULT 0
      description: "证件类型枚举：0-身份证, 1-护照, 2-台胞证, 3-港澳通行证"
    - name: id_card
      type: VARCHAR(30)
      constraint: NOT NULL
      description: "证件号码（建议后端存储时加密，此处逻辑描述假设为明文或解密后处理）"
    - name: type
      type: SMALLINT
      constraint: DEFAULT 0
      description: "旅客类型枚举：0-成人, 1-学生, 2-儿童"
    - name: phone
      type: VARCHAR(20)
      constraint: NOT NULL
      description: "联系手机号"
    - name: is_default
      type: BOOLEAN
      constraint: DEFAULT FALSE
      description: "是否为本人（默认乘客），true则不可删除"
    - name: verify_status
      type: SMALLINT
      constraint: DEFAULT 0
      description: "身份核验状态：0-未通过/待核验, 1-已通过"
    - name: phone_verified
      type: BOOLEAN
      constraint: DEFAULT FALSE
      description: "手机核验状态"
    - name: created_at
      type: TIMESTAMP
      constraint: DEFAULT CURRENT_TIMESTAMP
    - name: updated_at
      type: TIMESTAMP
      constraint: DEFAULT CURRENT_TIMESTAMP

  indexes:
    - name: idx_passenger_user
      columns: [user_id]
      description: "加速查询当前用户的乘车人列表"
    - name: uq_user_id_card
      columns: [user_id, id_type, id_card]
      unique: true
      description: "联合唯一索引，防止同一用户重复添加同一个证件号的乘车人"

functional_description: |
  该模块允许用户管理常用的乘车人信息。包含查看乘车人列表、新增、修改、以及单个或批量删除操作。
  核心逻辑：
  - 用户本人信息会自动同步为“默认乘客”，且不可删除。
  - 乘车人信息包含敏感数据剥离（姓名、证件号、手机号掩码）。
  - 有购票记录的乘车人受系统保护，禁止物理删除。
  - 包含证件类型校验与重复性校验。

ui_description: |
  
  - 采用 12306 经典个人中心布局，左侧为导航，右侧为管理面板。
  - 列表采用表格展示，表头为浅灰色背景（#f8f8f8）。
  - 核验状态以图标形式展示在表格中。

scenarios:
  - name: 管理常用乘车人
    steps:
      - action: 进入“乘车人管理”页面
        expectation: 列表显示当前账号下所有乘车人，第一行显示“本人”。
      - action: 在搜索框输入“张三”并点击查询
        expectation: 列表即时过滤，仅显示姓名包含“张三”的人员。

children:
  # ------------------------------------------
  # REQ-4-1: 乘车人列表展示
  # ------------------------------------------
  - id: REQ-4-1
    name: 乘车人列表展示
    database_interaction: |
      - SQL查询逻辑:
        ```sql
        SELECT * FROM passengers 
        WHERE user_id = :current_user_id 
        ORDER BY is_default DESC, created_at ASC
        LIMIT :page_size OFFSET :offset;
        ```
      - 注意：`is_default DESC` 确保本人（True）永远排在第一位。
    functional_description: |
      展示所有已保存的乘车人数据。
      - 排序规则：默认乘客（is_default=true）置顶，其余按创建时间升序排列。
      - 数据脱敏（后端处理或前端处理均可，建议后端返回脱敏字段）：
        - 证件号：保留前 4 位和后 3 位，中间掩码（*）。
        - 手机号：前缀加 (+86)，保留前 3 位和后 4 位，中间 4 位掩码（*）。
    ui_description: |
      
      本人条目姓名后方带蓝色“本人”标签。
    children:
      - id: REQ-4-1-1
        name: 列表分页与搜索
        functional_description: "每页显示 10 条数据，支持按姓名模糊搜索。"
        database_interaction: |
          - 搜索SQL:
            ```sql
            SELECT * FROM passengers 
            WHERE user_id = :uid AND name LIKE :search_term 
            ORDER BY is_default DESC ...
            ```

  # ------------------------------------------
  # REQ-4-2: 新增乘车人
  # ------------------------------------------
  - id: REQ-4-2
    name: 新增乘车人
    database_interaction: |
      1. 唯一性检查：虽然数据库有Unique Index，但建议先查询反馈友好提示，或者捕获数据库 `UniqueViolation` 异常。
      2. 插入逻辑:
         ```sql
         INSERT INTO passengers (user_id, name, id_type, id_card, type, phone, created_at)
         VALUES (:uid, :name, :id_type, :id_card, :type, :phone, NOW())
         RETURNING id;
         ```
      3. 异常处理：捕获 PostgreSQL 错误码 `23505` (unique_violation)，返回前端“该证件号已存在”。
    functional_description: |
      提供对话框表单用于添加新成员。
      - 校验规则：
        - 姓名：必填，>=2字符。
        - 证件：类型下拉，号码正则校验。
        - 手机：11位数字。
      - 重复性检查：系统会比对“证件类型+证件号码”，若已存在则拦截。
    ui_description: |
      
      弹窗标题“新增乘车人”，提交按钮为橙色（#FF8200）。

  # ------------------------------------------
  # REQ-4-3: 修改乘车人信息
  # ------------------------------------------
  - id: REQ-4-3
    name: 修改乘车人信息
    database_interaction: |
      - 锁定校验：修改前检查 `is_default` 字段。如果前端传来的 `id` 对应的记录 `is_default` 为 true，后端需校验仅允许修改 phone 或 type，严禁修改 name 和 id_card（通常本人的核心信息需走实名认证流程修改）。
      - 更新逻辑:
        ```sql
        UPDATE passengers 
        SET name = :name, phone = :phone, type = :type, updated_at = NOW()
        WHERE id = :passenger_id AND user_id = :uid;
        ```
    functional_description: |
      点击操作列的编辑图标，回填数据至表单进行修改。
      - 特殊限制：不支持修改默认乘客（本人）的姓名和证件号。
    ui_description: |
      
      表单回填当前所选乘客的所有信息。

  # ------------------------------------------
  # REQ-4-4: 删除与批量删除
  # ------------------------------------------
  - id: REQ-4-4
    name: 删除与批量删除
    database_interaction: |
      1. 预检查（关联性约束）：
         查询订单表（假设表名为 `orders`），检查是否存在关联记录。
         ```sql
         SELECT count(*) FROM orders WHERE passenger_id IN (:list_of_ids) AND status NOT IN ('CANCELLED', 'COMPLETED');
         -- 具体状态需根据业务定义，通常未出行的订单禁止删除乘车人
         ```
         若 count > 0，抛出异常“存在关联订单，无法删除”。
      2. 默认乘客保护：
         ```sql
         DELETE FROM passengers 
         WHERE id IN (:list_of_ids) AND user_id = :uid AND is_default = FALSE;
         ```
         注意：加上 `is_default = FALSE` 条件，即使前端恶意传来本人ID，数据库层面也不会执行删除。
    functional_description: |
      - 单个/批量删除。
      - 保护逻辑：
        1. “本人”记录禁止删除。
        2. 若乘车人已有购票记录，后端拦截删除请求。
    ui_description: |
      
      批量删除按钮背景色为白色，带红色删除图标。

  # ------------------------------------------
  # REQ-4-5: 后端数据同步逻辑 (Sync)
  # ------------------------------------------
  - id: REQ-4-5
    name: 后端数据同步逻辑
    database_interaction: |
      - 触发时机：用户登录后或首次访问乘客列表API时。
      - 逻辑流（伪代码/SQL混合）：
        1. 检查是否存在默认乘客：
           ```sql
           SELECT id FROM passengers WHERE user_id = :uid AND is_default = TRUE;
           ```
        2. 若不存在 (Result is Empty)，从 `users` 表获取信息并写入：
           ```sql
           INSERT INTO passengers (user_id, name, id_type, id_card, phone, is_default, type)
           SELECT id, real_name, id_type, id_card, phone, TRUE, 0
           FROM users 
           WHERE id = :uid;
           ```
      - 事务控制：此操作应在一个 Transaction 中完成，确保数据一致性。
    functional_description: |
      系统启动时自动同步。如果数据库中尚无当前用户的默认乘客记录，则自动抓取 User 表中的真实姓名、证件、电话创建一条 `is_default=true` 的乘客记录。