id: REQ-5
name: 系统集成与一致性
functional_description: |
  本模块用于规范跨模块的系统集成行为，确保以下端到端一致性：
  1. 路由与页面跳转：从车票查询、订单创建/确认、支付、订单详情到个人中心各页面的跳转路径、参数传递保持一致。
  2. 乘车人与本人信息集成：保证用户基础信息与“本人/默认乘车人”数据同步、一致且不重复。
  3. 订单与用户隔离：任何订单只能被其所属用户查看与操作，前后端均需做访问控制。
  4. 车次时间信息同步：从选定车次到订单创建、支付、详情展示，出发/到达站及时间等关键字段完整贯通。
  5. 自动化集成测试：为上述关键集成链路编写前端 E2E 测试与后端集成测试，确保在 CI 中可靠回归。
ui_description: |
  本模块不新增独立页面，主要约束现有页面间的导航和数据一致性。
  相关页面包括但不限于：
  - 车票查询页：LeftTicketSingle.vue, LeftTicketRound.vue
  - 订单相关页面：OrderCreate.vue, OrderConfirm.vue, OrderDetail.vue, OrderSuccess.vue
  - 个人中心页面：PassengerPage.vue, OrderPage.vue, ProfilePage.vue
scenarios:
  - name: 单用户完整购票与查看流程
    steps:
      - action: 用户 A 登录，完成车票查询并跳转到订单确认页，提交订单并完成支付。
        expectation: 订单创建成功，支付成功后可在“我的订单”列表和订单详情页中看到该订单。
      - action: 用户 A 在个人中心查看乘车人列表。
        expectation: 列表中存在且仅存在一条“本人/默认乘车人”记录，与用户 A 账户信息一致。
  - name: 多用户订单与乘车人隔离
    steps:
      - action: 用户 A 和用户 B 分别登录并各自创建至少一个订单。
        expectation: A 在“我的订单”列表中仅能看到 A 的订单；B 仅能看到 B 的订单。
      - action: 用户 A 和用户 B 分别进入“乘车人管理”页面。
        expectation: 各自页面中仅展示属于自己的乘车人，不会互相泄露数据。

children:
  - id: REQ-5-1
    name: 路由与跨模块导航一致性
    functional_description: |
      规范各业务模块之间的页面跳转与路由参数传递：
      1. 车票查询 -> 订单创建/确认：
         - 从 `/leftTicket/single` 或 `/leftTicket/round` 点击“预订”后，跳转至 `/order/create` 或 `/order/confirm`，并携带选中车次、日期、席别等信息。
      2. 订单创建/确认 -> 支付：
         - 订单创建成功后，跳转至支付页或在当前页展示支付区域，携带订单号、金额、剩余倒计时等关键信息。
      3. 支付 -> 订单详情/订单列表：
         - 支付成功后，支持跳转至 `/order/:orderId` 或 `/user/orders`，并保证订单状态与金额显示正确。
      4. 个人中心入口：
         - `/user` 下的子路由（如 `/user/passengers`、`/user/orders`）通过统一的布局和导航入口进入。
    ui_description: |
      前端路由表中，每个路径需在元数据中标注关联 REQ 编号（如 `/order/confirm` -> REQ-3-1, REQ-5-1），便于溯源。
    scenarios:
      - name: 车票查询到订单确认的参数同步
        steps:
          - action: 在 `/leftTicket/single` 选择某一车次并点击“预订”。
            expectation: 跳转到 `/order/confirm`，页面顶部展示的车次信息与查询列表中选中的完全一致。
      - name: 支付成功后的导航
        steps:
          - action: 在订单支付页点击“确认支付”。
            expectation: 状态更新为“已支付”，并跳转至订单详情页或订单成功页，展示同一订单的数据。

  - id: REQ-5-2
    name: 乘车人与本人信息同步
    functional_description: |
      保证 User 表中的用户基础信息与 passengers 表中的“本人/默认乘车人”记录保持一致、唯一且可追溯：
      1. 自动创建默认乘车人：
         - 当用户第一次访问乘车人页面或下单时，如无 `is_default = true` 的乘车人记录，则自动以当前用户的实名信息创建一条乘车人。
      2. 本人与 selfuser 一致性：
         - 默认乘车人的姓名、证件类型、证件号码、手机号必须与用户账户信息保持一致。
         - 修改个人信息后，同步更新默认乘车人；若因数据冲突无法更新，应记录错误并给出用户提示。
      3. 默认乘车人唯一性：
         - 每个用户在 passengers 表中最多存在一条 `is_default = true` 记录。
         - 不允许通过新增接口重复创建“本人/selfuser”；若出现多个默认乘车人，系统需在后端做纠正或拒绝写入。
      4. 乘车人列表隔离：
         - `/api/passengers` 接口必须按 `user_id` 过滤，仅返回当前登录用户的乘车人。
    ui_description: |
      乘车人列表页中，默认乘车人置顶展示，并在姓名旁显示“本人”标记。
    scenarios:
      - name: 新用户首次访问乘车人页
        steps:
          - action: 新注册用户首次登录并进入“乘车人管理”页面。
            expectation: 列表中自动出现一条与账户信息一致的“本人”记录。
      - name: 避免重复 selfuser 记录
        steps:
          - action: 多次执行会触发自动同步逻辑的操作（如重复登录后访问乘车人页）。
            expectation: 数据库中始终只保留一条默认乘车人记录，乘车人列表中不会出现多个“本人/selfuser”。
      - name: 乘车人与用户信息同步
        steps:
          - action: 用户在个人信息页面修改手机号或实名信息（若业务允许）。
            expectation: 默认乘车人记录同步更新对应字段，乘车人页展示内容与个人信息保持一致。

  - id: REQ-5-3
    name: 订单与用户隔离与可见性
    functional_description: |
      保证订单数据在多用户场景下的隔离性与安全性：
      1. 订单创建归属：
         - 通过 `/api/orders` 创建订单时，后端根据当前登录用户自动写入 `user_id` 字段，前端不得由客户端指定订单归属用户。
      2. 列表查询隔离：
         - “我的订单”列表接口仅返回 `user_id = current_user.id` 的订单。
      3. 详情访问控制：
         - 访问 `/order/:orderId` 或对应后端接口时，如订单不属于当前用户，应返回 404 或 403，前端展示“无权访问该订单”提示。
      4. 支付与退票权限控制：
         - 只有订单所有者可以触发支付、退票等操作。
    ui_description: |
      在前端的“我的订单”页面中，任何情况下都不应展示其他用户的订单。
    scenarios:
      - name: 多用户订单隔离
        steps:
          - action: 用户 A 和 B 分别创建订单 A1 和 B1。
            expectation: A 在订单列表中只能看到 A1，B 只能看到 B1。
          - action: 用户 B 手动访问 `/order/{A1.id}`。
            expectation: 返回 404 或 403，页面展示“订单不存在或无权访问”。

  - id: REQ-5-4
    name: 订单确认页车次时间同步
    functional_description: |
      保证用户在选定车次后，订单确认页与后端订单数据中的车次时间完全一致：
      1. 查询页到确认页字段映射：
         - 从车票查询结果中选择车次时，需将出发站、到达站、发车时间、到达时间、历时、日期等字段一并传递至订单确认页。
      2. 确认页展示：
         - 订单确认页顶部车次信息区域应显示上述字段，并与查询页中选中的内容一一对应。
      3. 订单创建请求体：
         - 调用创建订单接口时，需在请求体中包含车次时间相关字段，后端持久化存储。
      4. 表单校验：
         - 若出发时间或到达时间为空，应视为前端/后端集成错误，禁止提交并提示用户稍后重试。
    ui_description: |
      订单确认页中的车次信息区域使用票面样式展示，并在提交按钮附近再次展示出发和到达时间摘要，避免用户误操作。
    scenarios:
      - name: 车次时间字段完整传递
        steps:
          - action: 在车票查询页选择某车次并跳转到订单确认页。
            expectation: 订单确认页顶部展示的出发/到达时间与查询结果一致且不为空。
      - name: 防止空时间提交
        steps:
          - action: 在订单确认页点击“提交订单”。
            expectation: 若车次时间字段为空，前端阻止提交并提示“车次信息异常，请返回重新选择”；后端不会生成订单。

  - id: REQ-5-5
    name: 订单支付与详情车次信息同步
    functional_description: |
      确保订单支付流程与详情展示中使用同一份车次时间数据：
      1. 支付页展示：
         - 支付页中展示的车次信息应来自订单记录，而非重新查询，以保证与订单详情一致。
      2. 详情页展示：
         - 订单详情页中的车次信息区域显示的出发/到达站、时间与订单创建时保存的一致。
      3. 状态流转后的一致性：
         - 在订单从“待支付”变为“已支付”后，无论从订单列表、支付成功页还是详情页入口进入，都应看到一致的车次时间信息。
    ui_description: |
      订单详情页和支付页中的车次信息区域使用统一组件或统一数据源，避免字段遗漏。
    scenarios:
      - name: 支付后查看详情
        steps:
          - action: 用户完成订单支付后，从“支付成功”页点击“查看订单详情”。
            expectation: 订单详情页中展示的车次出发/到达时间与支付前确认页中的时间完全一致。
      - name: 列表页进入详情
        steps:
          - action: 返回“我的订单”列表，点击刚刚支付的订单。
            expectation: 详情页展示同一订单的车次时间信息，不出现空字段或不一致情况。

  - id: REQ-5-6
    name: 自动化集成测试覆盖
    functional_description: |
      为上述集成需求制定最小自动化测试覆盖要求：
      1. 前端 E2E 测试：
         - 在 `frontend/tests-e2e/` 目录中，为 REQ-5-1 至 REQ-5-5 分别编写至少 1 个端到端用例。
         - 测试内容包括：路由跳转、乘车人与用户信息联动、订单可见性、车次时间字段完整性等。
      2. 后端集成测试：
         - 在 `backend/tests/integration/` 目录中，为订单与乘车人相关的 API 编写集成测试，覆盖用户隔离、默认乘车人同步、订单车次时间持久化等场景。
      3. CI 校验：
         - 在持续集成流水线中，执行后端集成测试与前端 E2E 测试，所有用例必须通过后才允许合并代码。
    ui_description: |
      无独立 UI，仅约束测试代码与 CI 流程。
    scenarios:
      - name: CI 流水线集成测试通过
        steps:
          - action: 提交涉及订单或乘车人集成逻辑的代码变更并触发 CI。
            expectation: 后端集成测试与前端 E2E 测试全部通过；如有失败，阻止合并并在报告中显示对应 REQ 编号。

